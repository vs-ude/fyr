<html>
    <head>
        <meta charset="UTF-8"> 
        <title>WASM Example</title>
    </head>
    <body>
        <h1>WASM Example</h1>
        <script>
            let memory = new WebAssembly.Memory({initial: 100});
            let memory_u32 = new Uint32Array(memory.buffer);
            let memory_u8 = new Uint32Array(memory.buffer);
            let importObject = {
                imports: {
                    logString: function(sp) {
                        var offset = memory_u32[sp >> 2];
                        var bytes = new Uint8Array(memory.buffer, offset + 4, memory_u32[offset >> 2]);
                        var string = new TextDecoder('utf8').decode(bytes);
                        console.log(string);
                    },
                    logNumber: function(n) {
                        console.log(n);
                    },
                    mem: memory
                }
            };

            function decodeString(offset) {
                var l = new Uint32Array(memory.buffer, offset, 1);
                var bytes = new Uint8Array(memory.buffer, offset + 4, l[0]);
                return new TextDecoder('utf8').decode(bytes);
            }

            fetch('scratch.wasm').then(response =>
                response.arrayBuffer()
            ).then(bytes =>
                WebAssembly.instantiate(bytes, importObject)
            ).then(results => {
                console.log("Init root ...")
                let stack = results.instance.exports.initializeMemory();
//                console.log("main ..., stack=", stack);
//                results.instance.exports.main(stack);
                console.log("mapDemo ..., stack=", stack);
                let m = results.instance.exports.mapDemo(stack);
                console.log("m=", m);
                m = results.instance.exports.mapDemo2(stack);
                console.log("m=", m);
                console.log("Done");
            });
        </script>
    </body>
</html>