<html>
    <head>
        <meta charset="UTF-8"> 
        <title>WASM Example</title>
    </head>
    <body>
        <h1>WASM Example</h1>
        <canvas id="canvas" width="640" height="640"></canvas>
        <script>
            let memory = new WebAssembly.Memory({initial: 600});
            let memory_u32 = new Uint32Array(memory.buffer);
            let memory_u8 = new Uint8Array(memory.buffer);
            let importObject = {
                imports: {
                    logString: function(sp) {
                        var offset = memory_u32[sp >> 2];
                        var bytes = new Uint8Array(memory.buffer, offset + 4, memory_u32[offset >> 2]);
                        var string = new TextDecoder('utf8').decode(bytes);
                        console.log(string);
                    },
                    logNumber: function(n) {
                        console.log(n);
                    },
                    logFloat: function(n) {
                        console.log(n);
                    },
                    mem: memory
                }
            };

            function decodeString(offset) {
                var l = new Uint32Array(memory.buffer, offset, 1);
                var bytes = new Uint8Array(memory.buffer, offset + 4, l[0]);
                return new TextDecoder('utf8').decode(bytes);
            }


            fetch('mandelbrot_fast.wasm').then(response =>
                response.arrayBuffer()
            ).then(bytes =>
                WebAssembly.instantiate(bytes, importObject)
            ).then(results => {
//                console.log("Init root ...")
//                let stack = results.instance.exports.initializeMemory();
                console.log(new Date());
                console.log("mandelbrot...");
                let pixels = results.instance.exports.main();
                console.log("Done, pixels=", pixels);
                console.log(new Date());
/*
                let canvas = document.getElementById("canvas");
                let ctx = canvas.getContext('2d');
                let img = ctx.createImageData(640, 640);
                let data = img.data;
                for(let i = 0; i < 640 * 640; i += 8) {
                    let p = memory_u8[pixels + i/8];
//                    console.log(pixels + i/8, p);
                    for(let b = 7; b >= 0; b--) {
                        if (p & 1) {
                            data[(i+b)*4] = 128;
                            data[(i+b)*4 + 1] = 0;
                            data[(i+b)*4 + 2] = 0;
                            data[(i+b)*4 + 3] = 128;
                        }
                        p = p >> 1;
                    }
                }
                ctx.putImageData(img, 0, 0);
                */
            });
        </script>
    </body>
</html>